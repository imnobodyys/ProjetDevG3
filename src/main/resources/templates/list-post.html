<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Liste des Posts</title>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    <h1>📢 Posts</h1>

    <div>
       <div th:if="${pageType == 'mes'}">
            <a href="/posts/liste">🌍 Voir tous les posts</a>
        </div>

        <div th:if="${pageType == 'tous'}">
            <a href="/posts/mes-posts">👤 Mes posts</a>
        </div>

        <a href="/posts/nouveau">✍️ Rédiger un post</a>
    </div>

    <hr>

    <div th:if="${posts.isEmpty()}">
        <p>Aucun post trouvé.</p>
    </div>

    <div th:each="post : ${posts}">
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
            <p>
                <a th:href="@{'/posts/voir/' + ${post.id}}">🔍 Voir plus</a>
            </p>
            <p><strong th:text="${post.auteur.nom}">Auteur</strong></p>
            <p th:text="${post.contenu}">Contenu du post</p>

            <!-- Supprimer bouton si auteur -->
            <div th:if="${utilisateurConnecte != null and post.auteur.id == utilisateurConnecte.id}">
                <form th:action="@{'/posts/supprimer/' + ${post.id}}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit">🗑 Supprimer</button>
                </form>
            </div>
            <!-- Réagir avec des emojis -->
        <form th:action="@{'/posts/' + ${post.id} + '/reaction'}" method="post" style="display:inline;">
            <input type="hidden" name="type" value="JAIME" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">👍 J’aime</button>
        </form>

        <form th:action="@{'/posts/' + ${post.id} + '/reaction'}" method="post" style="display:inline;">
            <input type="hidden" name="type" value="BRAVO" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">👏 Bravo</button>
        </form>

        <form th:action="@{'/posts/' + ${post.id} + '/reaction'}" method="post" style="display:inline;">
            <input type="hidden" name="type" value="COOL" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">😎 Cool</button>
        </form>

        <form th:action="@{'/posts/' + ${post.id} + '/reaction'}" method="post" style="display:inline;">
            <input type="hidden" name="type" value="INTERESSANT" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">🤔 Intéressant</button>
        </form>

        <form th:action="@{'/posts/' + ${post.id} + '/reaction'}" method="post" style="display:inline;">
            <input type="hidden" name="type" value="TRISTE" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">😢 Triste</button>
        </form>

        <div>
            <p>
                👍 <span th:text="${reactionsStats[post.id]['JAIME'] ?: 0}">0</span>
                👏 <span th:text="${reactionsStats[post.id]['BRAVO'] ?: 0}">0</span>
                😎 <span th:text="${reactionsStats[post.id]['COOL'] ?: 0}">0</span>
                🤔 <span th:text="${reactionsStats[post.id]['INTERESSANT'] ?: 0}">0</span>
                😢 <span th:text="${reactionsStats[post.id]['TRISTE'] ?: 0}">0</span>
            </p>
        </div>
        <div>
    Post ID: <span th:text="${post.id}"></span>
    Reactions: <span th:text="${reactionsStats[post.id]}"></span>
</div>
        <div th:if="${reactionsStats}">
            <p>Debug: <span th:text="${reactionsStats}"></span></p>
        </div>

            <!-- Liste des commentaires -->
            <div th:if="${post.commentaires != null}">
                <h4>💬 Commentaires :</h4>
                <ul>
                    <li th:each="comment : ${post.commentaires}">
                        <strong th:text="${comment.expediteur.nom}">Nom</strong> :
                        <span th:text="${comment.contenu}">Contenu</span>
                    </li>
                </ul>
            </div>


            <!-- Formulaire de commentaire -->
            <form th:action="@{'/posts/' + ${post.id} + '/commenter'}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <textarea name="contenu" rows="2" cols="50" placeholder="Écrivez un commentaire..." required></textarea><br>
                <button type="submit">💬 Commenter</button>
            </form>
        </div>
    </div>
    <div>
        Total posts: <span th:text="${posts.size()}">0</span>
    </div>
</body>
</html>
